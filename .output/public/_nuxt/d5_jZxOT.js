import{I as p,M as W,m as X,G as h,z as Y,N as I,O as Z,b as N,i as ee,o as l,a as s,w as te,f as w,c as d,e as y,j as ae,k as b,K as U,t as u,F as P,g as B,P as S,R as se}from"./DDT-0HTi.js";import{M as re}from"./D_ZLElLM.js";import{e as R}from"./B4pxijLT.js";import"./DlAUqK2U.js";const ne=window.setInterval,M=new Map,T=new Map,ie=300*1e3;function oe(){const r=p(new Map),E=i=>{const m=T.get(i);return m?Date.now()-m<ie:!1},f=i=>E(i)?M.get(i):null,C=(i,m)=>{M.set(i,m),T.set(i,Date.now())};return{cachedApiCall:async(i,m,g=!1)=>{if(!g){const c=f(i);if(c)return c}if(r.value.get(i))return new Promise(c=>{const _=ne(()=>{if(!r.value.get(i)){clearInterval(_);const v=f(i);c(v)}},100)});r.value.set(i,!0);try{const c=await m();return C(i,c),c}finally{r.value.delete(i)}},getFromCache:f,setCache:C,clearCache:i=>{i?(M.delete(i),T.delete(i)):(M.clear(),T.clear())},isCacheValid:E}}const ce={__name:"form",props:{show:Boolean,role:Object,statusEnums:{type:Array,default:()=>[]},apiErrors:{type:Object,default:()=>({})}},emits:["submit","cancel"],setup(r,{emit:E}){const f=W(),{$loadMultiselect:C}=X(),D=p(null),k=p(!1),i=async()=>{if(!k.value)try{D.value=await C(),k.value=!0}catch(t){console.error("Failed to load Multiselect:",t)}},m=r,g=E,c=h(()=>{const t={};return Array.isArray(m.statusEnums)&&m.statusEnums.forEach(a=>{t[a.value]=a.label}),t}),_=h(()=>O.value.map(t=>({value:t.id,label:t.display_name||t.name}))),v=p([]),z=async()=>{try{const t=await f.get(R.roles.list,{params:{per_page:1e3}});v.value=t.data.data||[]}catch{v.value=[]}},O=p([]),V=p(!1),G=async()=>{const{cachedApiCall:t}=oe();V.value=!0;try{const a=await t("permissions-list",()=>f.get(R.permissions.list,{params:{per_page:1e3}}),!1);O.value=a.data.data||[]}catch{O.value=[]}finally{V.value=!1}};Y(async()=>{await i(),z(),G()});const H=h(()=>m.role?"Chỉnh sửa vai trò":"Thêm vai trò mới"),j=h({get:()=>m.show,set:()=>q()}),e=I({name:"",display_name:"",guard_name:"",parent_id:"",status:"active",permissions:[]}),o=I({}),A=p(!1);Z(()=>m.role,t=>{t?(e.name=t.name||"",e.display_name=t.display_name||"",e.guard_name=t.guard_name||"",e.parent_id=t.parent_id||"",e.status=t.status||"active",t.permissions&&Array.isArray(t.permissions)?e.permissions=t.permissions.map(a=>({value:a.id||a,label:a.display_name||a.name})):e.permissions=[]):K()},{immediate:!0});function K(){e.name="",e.display_name="",e.guard_name="",e.parent_id="",e.status="active",e.permissions=[],F()}function F(){Object.keys(o).forEach(t=>delete o[t])}const L=h(()=>({name:[{required:"Tên vai trò là bắt buộc"}],display_name:[{required:"Tên hiển thị là bắt buộc"}]}));function Q(){F();let t=!0;const a=L.value;for(const n in a)for(const x of a[n])if(x.required&&!e[n]){o[n]=x.required,t=!1;break}return t}function $(){if(Q()){A.value=!0;try{const t={name:e.name,display_name:e.display_name,guard_name:e.guard_name,parent_id:e.parent_id||null,status:e.status,permissions:[]};e.permissions&&e.permissions.length>0&&(t.permissions=e.permissions.map(a=>typeof a=="object"?a.value:a)),g("submit",t)}finally{A.value=!1}}}function J(t){e.permissions=t||[]}function q(){g("cancel")}return(t,a)=>(l(),N(re,{modelValue:j.value,"onUpdate:modelValue":a[6]||(a[6]=n=>j.value=n),title:H.value},{default:ee(()=>[s("form",{onSubmit:te($,["prevent"]),class:"space-y-4"},[s("div",null,[s("label",{for:"name",class:"block text-sm font-medium text-gray-700 mb-1"},[ae("Tên vai trò "),s("span",{class:"text-red-500"},"*")]),w(s("input",{id:"name","onUpdate:modelValue":a[0]||(a[0]=n=>e.name=n),type:"text",class:b(["w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.name||r.apiErrors.name}])},null,2),[[U,e.name]]),o.name?(l(),d("p",{key:0,class:"mt-1 text-sm text-red-600"},u(o.name),1)):r.apiErrors.name?(l(),d("p",{key:1,class:"mt-1 text-sm text-red-600"},u(r.apiErrors.name),1)):y("",!0)]),s("div",null,[s("label",{for:"display_name",class:"block text-sm font-medium text-gray-700 mb-1"},"Tên hiển thị"),w(s("input",{id:"display_name","onUpdate:modelValue":a[1]||(a[1]=n=>e.display_name=n),type:"text",class:b(["w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.display_name||r.apiErrors.display_name}])},null,2),[[U,e.display_name]]),o.display_name?(l(),d("p",{key:0,class:"mt-1 text-sm text-red-600"},u(o.display_name),1)):r.apiErrors.display_name?(l(),d("p",{key:1,class:"mt-1 text-sm text-red-600"},u(r.apiErrors.display_name),1)):y("",!0)]),s("div",null,[s("label",{for:"guard_name",class:"block text-sm font-medium text-gray-700 mb-1"},"Guard"),w(s("input",{id:"guard_name","onUpdate:modelValue":a[2]||(a[2]=n=>e.guard_name=n),type:"text",class:b(["w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.guard_name||r.apiErrors.guard_name}])},null,2),[[U,e.guard_name]]),o.guard_name?(l(),d("p",{key:0,class:"mt-1 text-sm text-red-600"},u(o.guard_name),1)):r.apiErrors.guard_name?(l(),d("p",{key:1,class:"mt-1 text-sm text-red-600"},u(r.apiErrors.guard_name),1)):y("",!0)]),s("div",null,[s("label",{for:"parent_id",class:"block text-sm font-medium text-gray-700 mb-1"},"Vai trò cha"),w(s("select",{id:"parent_id","onUpdate:modelValue":a[3]||(a[3]=n=>e.parent_id=n),class:b(["w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.parent_id||r.apiErrors.parent_id}])},[s("option",{value:""},"-- Không có --"),(l(!0),d(P,null,B(v.value,n=>(l(),d("option",{key:n.id,value:n.id},u(n.display_name||n.name),9,["value"]))),128))],2),[[S,e.parent_id]]),o.parent_id?(l(),d("p",{key:0,class:"mt-1 text-sm text-red-600"},u(o.parent_id),1)):r.apiErrors.parent_id?(l(),d("p",{key:1,class:"mt-1 text-sm text-red-600"},u(r.apiErrors.parent_id),1)):y("",!0)]),s("div",null,[s("label",{for:"status",class:"block text-sm font-medium text-gray-700 mb-1"},"Trạng thái"),w(s("select",{id:"status","onUpdate:modelValue":a[4]||(a[4]=n=>e.status=n),class:b(["w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",{"border-red-500":o.status||r.apiErrors.status}])},[(l(!0),d(P,null,B(c.value,(n,x)=>(l(),d("option",{key:x,value:x},u(n),9,["value"]))),128))],2),[[S,e.status]]),o.status?(l(),d("p",{key:0,class:"mt-1 text-sm text-red-600"},u(o.status),1)):r.apiErrors.status?(l(),d("p",{key:1,class:"mt-1 text-sm text-red-600"},u(r.apiErrors.status),1)):y("",!0)]),s("div",null,[s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Quyền"),V.value?(l(),d("div",{key:0,class:"text-center py-4 text-gray-500"}," Đang tải danh sách quyền... ")):(l(),d("div",{key:1},[k.value?(l(),N(se(D.value),{key:1,modelValue:e.permissions,"onUpdate:modelValue":a[5]||(a[5]=n=>e.permissions=n),options:_.value,multiple:!0,searchable:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Chọn quyền...",label:"label","track-by":"value","preselect-first":!1,class:b({"border-red-500":o.permissions||r.apiErrors.permissions}),onInput:J},null,40,["modelValue","options","class"])):(l(),d("div",{key:0,class:"flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg"},[s("div",{class:"text-center"},[s("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),s("p",{class:"text-gray-600 text-sm"},"Đang tải component...")])]))])),o.permissions?(l(),d("p",{key:2,class:"mt-1 text-sm text-red-600"},u(o.permissions),1)):r.apiErrors.permissions?(l(),d("p",{key:3,class:"mt-1 text-sm text-red-600"},u(r.apiErrors.permissions),1)):y("",!0)]),s("div",{class:"flex justify-end space-x-3 pt-4"},[s("button",{type:"button",onClick:q,class:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none"}," Hủy "),s("button",{type:"submit",class:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none",disabled:A.value},u(A.value?"Đang xử lý...":r.role?"Cập nhật":"Thêm mới"),9,["disabled"])])],32)]),_:1},8,["modelValue","title"]))}};export{ce as default};
